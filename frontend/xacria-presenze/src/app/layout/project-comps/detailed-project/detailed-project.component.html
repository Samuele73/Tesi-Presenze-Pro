<!-- Case 1: loading -->
<ng-container *ngIf="isLoading; else checkProject">
  <div class="container-fluid text-center p-5">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <p class="text-muted">Caricamento progetto...</p>
  </div>
</ng-container>

<!-- Case 2: Check project -->
<ng-template #checkProject>
  <div class="d-flex flex-column h-100" style="overflow: hidden">
    <!-- Header -->
    <div
      class="mb-3 d-flex align-items-center justify-content-xl-between px-3 pt-3 flex-shrink-0"
    >
      <a
        [routerLink]="['/app/projects']"
        class="text-decoration-none text-muted d-flex align-items-center"
      >
        <i class="fa-solid fa-arrow-left me-2"></i>
        {{ "Lista Progetti" | translate }}
      </a>
    </div>

    <div class="flex-grow-1" style="overflow-y: auto; overflow-x: hidden">
      <ng-container *ngIf="showContent; else noProject">
        <div class="container-fluid px-3 pb-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <!-- DETTAGLI / EDIT SWITCH -->
              <ng-container *ngIf="!authService.isAdmin(); else editModeTemplate">
                <!-- Dettagli Progetto -->
                <div
                  class="d-flex justify-content-between align-items-start flex-wrap mb-3"
                >
                  <div>
                    <div class="d-flex align-items-center gap-3 mb-1">
                      <h2 class="fw-bold mb-0">{{ project?.name }}</h2>
                      <app-project-status
                        [project]="project"
                        class="fs-6"
                      ></app-project-status>
                    </div>
                    <small class="text-muted">ID: {{ project?.id }}</small>
                  </div>
                </div>

                <hr />

                <div class="mb-4">
                  <h5 class="fw-semibold mb-1">
                    <i class="bi bi-file-text me-1"></i>{{"Riepilogo" | translate}}
                  </h5>
                  <p class="text-muted mb-0">{{ project?.summary || "—" }}</p>
                </div>

                <div class="mb-4">
                  <h5 class="fw-semibold mb-1">
                    <i class="bi bi-card-text me-1"></i>{{"Descrizione" | translate}}
                  </h5>
                  <p class="text-muted" style="white-space: pre-wrap">
                    {{ project?.description || "—" }}
                  </p>
                </div>

                <div>
                  <h5 class="fw-semibold mb-2">
                    <i class="bi bi-people me-1"></i>
                    <span class="text-primary">{{
                      project?.assignedTo?.length || 0
                    }}</span>
                    {{ "Utenti Assegnati" | translate }}
                  </h5>

                  <div
                    *ngIf="project?.assignedTo?.length; else noUsers"
                    class="d-flex flex-wrap gap-2"
                  >
                    <app-chips
                      *ngFor="let email of project?.assignedTo"
                      [text]="email"
                      [mode]="getChipMode()"
                    ></app-chips>
                  </div>

                  <ng-template #noUsers>
                    <p class="text-muted mb-0">
                      <i class="bi bi-info-circle"></i> Nessun utente assegnato
                    </p>
                  </ng-template>
                </div>
              </ng-container>
            </div>
          </div>
        </div>

        <!-- EDIT MODE -->
        <ng-template #editModeTemplate>
          <form [formGroup]="projectForm" (ngSubmit)="onSubmit()">
            <!-- Nome -->
            <div class="mb-3">
              <label class="form-label fw-bold">{{ "Nome Progetto" | translate }}</label>
              <input type="text" class="form-control" formControlName="name" />
              <app-form-error
                [formControlRef]="formName"
                validator="required"
                errorText="Il nome del progetto è obbligatorio"
              ></app-form-error>
            </div>

            <!-- Riepilogo -->
            <div class="mb-3">
              <label class="form-label fw-bold">{{ "Riepilogo" | translate }}</label>
              <input
                type="text"
                class="form-control"
                formControlName="summary"
              />
              <app-form-error
                [formControlRef]="formSummary"
                validator="required"
                errorText="Il riepilogo è obbligatorio"
              ></app-form-error>
            </div>

            <!-- Descrizione -->
            <div class="mb-3">
              <label class="form-label fw-bold">{{ "Descrizione" | translate }}</label>
              <textarea
                class="form-control"
                formControlName="description"
                rows="4"
              ></textarea>
              <app-form-error
                [formControlRef]="formDescription"
                validator="required"
                errorText="La descrizione è obbligatoria"
              ></app-form-error>
            </div>

            <!-- Status -->
            <div class="mb-3">
              <label class="form-label fw-bold">{{ "Stato" | translate }}</label>
              <select class="form-select" formControlName="status">
                <option value="CREATED">Creato</option>
                <option value="IN_PROGRESS">In Corso</option>
                <option value="COMPLETED">Completato</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label fw-bold">{{ "Utenti Assegnati" | translate }}</label>

              <div
                class="d-flex flex-wrap gap-2 mb-2"
                *ngIf="assignedTo.controls.length > 0"
              >
                <app-chips
                  *ngFor="let ctrl of assignedTo.controls; let i = index"
                  [text]="ctrl.value"
                  [mode]="'DELETE'"
                  (delete)="removeUser(i)"
                ></app-chips>
              </div>

              <input
                type="email"
                class="form-control"
                placeholder="Aggiungi email utente"
                [(ngModel)]="newUserEmail"
                [ngModelOptions]="{ standalone: true }"
                #emailInput="ngModel"
                email
                (keydown.enter)="addUser(); $event.preventDefault()"
              />

              <!-- Messaggio errore -->
              <div *ngIf="emailInput.invalid && emailInput.touched">
                <small class="text-danger">{{ "Inserisci una email valida" | translate }}</small>
              </div>
              <small class="text-muted">{{ "Premi Invio per aggiungere" | translate }}</small>
            </div>

            <div class="d-flex justify-content-end gap-2">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="cancelEdit()"
              >
                {{ "Annulla" | translate }}
              </button>
              <button
                type="submit"
                class="btn btn-primary text-white"
                [disabled]="projectForm.invalid"
              >
                {{ "Salva" | translate }}
              </button>
            </div>
          </form>
        </ng-template>
      </ng-container>
    </div>
  </div>
</ng-template>

<!-- Case 3: no project -->
<ng-template #noProject>
  <div
    class="container-fluid w-100 h-100 d-flex align-items-center justify-content-center"
  >
    <div class="text-center" style="max-width: 500px">
      <h1 class="display-4 fw-bold text-danger mb-3">{{ statusCode }}</h1>
      <h4 class="fw-semibold mb-3">{{ backupTitle }}</h4>
      <button
        class="btn btn-primary text-white fw-semibold px-4 py-2"
        [routerLink]="['/app/projects']"
      >
        <i class="bi bi-arrow-left me-2"></i>Torna alla lista
      </button>
    </div>
  </div>
</ng-template>
